{% extends "sqladmin/layout.html" %}

{% block content %}
<div class="master-chat-page">
  <div class="master-chat-shell">
    <aside class="master-chat-sidebar">
      <div class="master-chat-sidebar-header">
        <h2>Поддержка</h2>
        <p>Открытые чаты пользователей</p>
      </div>
      <div id="master-chat-list" class="master-chat-list"></div>
      <div class="master-chat-pagination">
        <button id="master-chat-prev-page" type="button">Назад</button>
        <span id="master-chat-page-info">1 / 1</span>
        <button id="master-chat-next-page" type="button">Вперед</button>
      </div>
    </aside>

    <section class="master-chat-main">
      <header class="master-chat-main-header">
        <div id="master-chat-selected-user">Выберите чат</div>
        <button id="master-chat-close-btn" class="master-chat-close-btn" type="button" disabled>
          Закрыть чат
        </button>
      </header>
      <div id="master-chat-messages" class="master-chat-messages">
        <div class="master-chat-empty">Выберите диалог слева, чтобы начать работу.</div>
      </div>
      <form id="master-chat-form" class="master-chat-form">
        <textarea
          id="master-chat-input"
          rows="1"
          placeholder="Напишите сообщение..."
          maxlength="2000"
          disabled
        ></textarea>
        <button id="master-chat-send-btn" type="submit" disabled>Отправить</button>
      </form>
    </section>
  </div>
</div>

<style>
  .master-chat-page {
    padding: 12px;
    height: calc(100dvh - 132px);
    min-height: 0;
    background: linear-gradient(135deg, #d8e8ff 0%, #eef3f8 38%, #d7e4f2 100%);
    box-sizing: border-box;
  }

  .master-chat-shell {
    display: grid;
    grid-template-columns: 360px 1fr;
    height: 100%;
    min-height: 0;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 16px 40px rgba(45, 59, 77, 0.18);
    background: #edf2f7;
  }

  .master-chat-sidebar {
    display: flex;
    flex-direction: column;
    min-height: 0;
    border-right: 1px solid #d5deea;
    background: #f9fbfd;
  }

  .master-chat-sidebar-header {
    padding: 14px 16px 10px;
    border-bottom: 1px solid #e2e8f0;
  }

  .master-chat-sidebar-header h2 {
    margin: 0;
    font-size: 18px;
    color: #1a2a41;
  }

  .master-chat-sidebar-header p {
    margin: 4px 0 0;
    color: #5f728a;
    font-size: 12px;
  }

  .master-chat-list {
    flex: 1;
    overflow: auto;
    min-height: 0;
  }

  .master-chat-list-item {
    padding: 10px 12px;
    border-bottom: 1px solid #ecf1f6;
    cursor: pointer;
    transition: background 0.2s ease;
    background: #ffffff;
  }

  .master-chat-list-item:hover {
    background: #edf4ff;
  }

  .master-chat-list-item.active {
    background: #d8e9ff;
  }

  .master-chat-list-title {
    font-weight: 600;
    font-size: 13px;
    color: #1c2f49;
    display: flex;
    justify-content: space-between;
    gap: 8px;
  }

  .master-chat-list-subtitle {
    margin-top: 4px;
    font-size: 12px;
    color: #6e8098;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .master-chat-list-unread {
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    background: #2ea6ff;
    color: #fff;
    font-size: 11px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 6px;
  }

  .master-chat-pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 10px 12px;
    border-top: 1px solid #e2e8f0;
    background: #f6f9fc;
  }

  .master-chat-pagination button {
    border: none;
    background: #2d7fe3;
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 12px;
  }

  .master-chat-pagination button:disabled {
    background: #b7c3d3;
  }

  .master-chat-main {
    display: flex;
    flex-direction: column;
    min-height: 0;
    background: radial-gradient(circle at top left, #f2f7ff 0%, #eaf1f8 50%, #e5edf7 100%);
  }

  .master-chat-main-header {
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 10px 16px;
    border-bottom: 1px solid #d7e2ee;
    background: #f9fcff;
  }

  #master-chat-selected-user {
    font-size: 15px;
    font-weight: 600;
    color: #1b2d46;
  }

  .master-chat-close-btn {
    border: none;
    background: #d64d4d;
    color: #fff;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
  }

  .master-chat-close-btn:disabled {
    background: #bdc6d1;
  }

  .master-chat-messages {
    flex: 1;
    overflow: auto;
    min-height: 0;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .master-chat-empty {
    margin: auto;
    color: #6f8196;
    font-size: 14px;
  }

  .master-chat-message {
    max-width: 74%;
    padding: 6px 10px;
    border-radius: 12px;
    box-shadow: 0 1px 4px rgba(20, 36, 56, 0.08);
    font-size: 13px;
    line-height: 1.3;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .master-chat-message.user {
    align-self: flex-start;
    background: #ffffff;
    border-bottom-left-radius: 4px;
    color: #1f2d3f;
  }

  .master-chat-message.support {
    align-self: flex-end;
    background: #d8ffd8;
    border-bottom-right-radius: 4px;
    color: #1d3b1d;
  }

  .master-chat-message.system {
    align-self: center;
    max-width: 60%;
    text-align: center;
    background: #e8edf3;
    color: #5f7287;
    border-radius: 999px;
    padding: 5px 11px;
  }

  .master-chat-message-meta {
    margin-top: 3px;
    font-size: 10px;
    color: #7a8d9f;
    line-height: 1.15;
  }

  .master-chat-form {
    border-top: 1px solid #d7e2ee;
    background: #f9fcff;
    padding: 10px 12px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 8px;
  }

  #master-chat-input {
    resize: none;
    border: 1px solid #c9d6e6;
    border-radius: 10px;
    padding: 8px 10px;
    font-size: 13px;
    outline: none;
  }

  #master-chat-send-btn {
    border: none;
    background: #2a89f0;
    color: #fff;
    border-radius: 10px;
    padding: 0 14px;
    font-size: 13px;
  }

  #master-chat-send-btn:disabled {
    background: #afc3da;
  }

  @media (max-width: 1024px) {
    .master-chat-page {
      height: auto;
      min-height: calc(100dvh - 88px);
      padding: 8px;
    }

    .master-chat-shell {
      grid-template-columns: 1fr;
      height: auto;
      min-height: calc(100vh - 104px);
    }

    .master-chat-sidebar {
      min-height: 260px;
      max-height: 320px;
    }
  }
</style>

<script>
  const MasterChatState = {
    selectedUserId: null,
    page: 1,
    pageSize: 20,
    totalPages: 1,
    chats: [],
    websocket: null,
  };

  function masterChatUnwrapData(payload) {
    if (payload && typeof payload === "object" && Object.prototype.hasOwnProperty.call(payload, "data")) {
      return payload.data;
    }
    return payload;
  }

  async function masterChatFetchJson(url, options = {}) {
    const response = await fetch(url, options);
    if (!response.ok) {
      const text = await response.text();
      throw new Error(text || "Request failed");
    }
    const payload = await response.json();
    return payload;
  }

  function masterChatFormatTime(value) {
    if (!value) {
      return "";
    }
    const date = new Date(value);
    return date.toLocaleString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
    });
  }

  function masterChatDisplayUser(chatItem) {
    const title = chatItem.user_phone || chatItem.user_email || `User #${chatItem.user_id}`;
    return `${title} (ID: ${chatItem.user_id})`;
  }

  function masterChatRenderChats() {
    const listNode = document.getElementById("master-chat-list");
    listNode.innerHTML = "";
    if (!MasterChatState.chats.length) {
      listNode.innerHTML = '<div class="master-chat-empty" style="padding: 16px;">Открытых чатов нет.</div>';
      return;
    }

    MasterChatState.chats.forEach((chatItem) => {
      const row = document.createElement("div");
      row.className = "master-chat-list-item";
      if (MasterChatState.selectedUserId === chatItem.user_id) {
        row.classList.add("active");
      }
      row.addEventListener("click", () => masterChatSelectChat(chatItem.user_id));

      const unreadBadge = chatItem.unread_user_messages_count > 0
        ? `<span class="master-chat-list-unread">${chatItem.unread_user_messages_count}</span>`
        : "";
      const preview = chatItem.last_message_text || "Нет сообщений";
      row.innerHTML = `
        <div class="master-chat-list-title">
          <span>${masterChatDisplayUser(chatItem)}</span>
          ${unreadBadge}
        </div>
        <div class="master-chat-list-subtitle">${preview}</div>
        <div class="master-chat-list-subtitle">${masterChatFormatTime(chatItem.last_message_created_at || chatItem.updated_at)}</div>
      `;
      listNode.appendChild(row);
    });
  }

  function masterChatRenderPagination() {
    document.getElementById("master-chat-page-info").textContent = `${MasterChatState.page} / ${MasterChatState.totalPages}`;
    document.getElementById("master-chat-prev-page").disabled = MasterChatState.page <= 1;
    document.getElementById("master-chat-next-page").disabled = MasterChatState.page >= MasterChatState.totalPages;
  }

  function masterChatRenderMessages(masterChat) {
    const messagesNode = document.getElementById("master-chat-messages");
    messagesNode.innerHTML = "";
    const messages = (masterChat && Array.isArray(masterChat.messages)) ? masterChat.messages : [];
    if (!messages.length) {
      messagesNode.innerHTML = '<div class="master-chat-empty">Сообщений пока нет.</div>';
      return;
    }
    messages.forEach((message) => {
      const bubble = document.createElement("div");
      const senderClass = message.sender_type === "support"
        ? "support"
        : (message.sender_type === "system" ? "system" : "user");
      const senderLabel = message.sender_type === "support"
        ? "Админ"
        : (message.sender_type === "system" ? "Система" : "Пользователь");
      bubble.className = `master-chat-message ${senderClass}`;
      if (senderClass === "system") {
        bubble.innerHTML = `
          <div>${message.message_text}</div>
          <div class="master-chat-message-meta">${masterChatFormatTime(message.created_at)}</div>
        `;
      } else {
        bubble.innerHTML = `
          <div>${message.message_text}</div>
          <div class="master-chat-message-meta">${senderLabel} · ${masterChatFormatTime(message.created_at)}</div>
        `;
      }
      messagesNode.appendChild(bubble);
    });
    messagesNode.scrollTop = messagesNode.scrollHeight;
  }

  function masterChatSetChatControlsEnabled(enabled) {
    document.getElementById("master-chat-input").disabled = !enabled;
    document.getElementById("master-chat-send-btn").disabled = !enabled;
    document.getElementById("master-chat-close-btn").disabled = !enabled;
  }

  async function masterChatLoadChats() {
    const payload = await masterChatFetchJson(`/support/master-chat/admin/chats?page=${MasterChatState.page}&page_size=${MasterChatState.pageSize}`);
    let items = [];
    let pagination = null;

    if (payload && Array.isArray(payload.data) && payload.pagination) {
      items = payload.data;
      pagination = payload.pagination;
    } else if (payload && Array.isArray(payload.items) && payload.pagination) {
      items = payload.items;
      pagination = payload.pagination;
    }

    MasterChatState.chats = items;
    if (pagination) {
      MasterChatState.totalPages = Math.max(1, pagination.total_pages || 1);
      MasterChatState.page = pagination.page || MasterChatState.page;
    } else {
      MasterChatState.totalPages = 1;
    }

    if (
      MasterChatState.selectedUserId !== null &&
      !MasterChatState.chats.some((chatItem) => chatItem.user_id === MasterChatState.selectedUserId)
    ) {
      MasterChatState.selectedUserId = null;
      document.getElementById("master-chat-selected-user").textContent = "Выберите чат";
      masterChatSetChatControlsEnabled(false);
      document.getElementById("master-chat-messages").innerHTML =
        '<div class="master-chat-empty">Выберите диалог слева, чтобы начать работу.</div>';
    }

    masterChatRenderChats();
    masterChatRenderPagination();
  }

  async function masterChatSelectChat(userId) {
    MasterChatState.selectedUserId = userId;
    const payload = await masterChatFetchJson(`/support/master-chat/admin/chats/${userId}`);
    const chatData = masterChatUnwrapData(payload);
    const sidebarChat = MasterChatState.chats.find((chatItem) => chatItem.user_id === userId);
    document.getElementById("master-chat-selected-user").textContent = sidebarChat
      ? masterChatDisplayUser(sidebarChat)
      : `User #${userId}`;
    masterChatSetChatControlsEnabled(true);
    masterChatRenderChats();
    masterChatRenderMessages(chatData);
  }

  async function masterChatSendMessage(event) {
    event.preventDefault();
    if (!MasterChatState.selectedUserId) {
      return;
    }
    const input = document.getElementById("master-chat-input");
    const messageText = input.value.trim();
    if (!messageText) {
      return;
    }
    await masterChatFetchJson(`/support/master-chat/admin/chats/${MasterChatState.selectedUserId}/messages`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message_text: messageText }),
    });
    input.value = "";
    await masterChatSelectChat(MasterChatState.selectedUserId);
    await masterChatLoadChats();
  }

  async function masterChatCloseSelectedChat() {
    if (!MasterChatState.selectedUserId) {
      return;
    }
    const ok = window.confirm("Закрыть этот чат?");
    if (!ok) {
      return;
    }
    await masterChatFetchJson(`/support/master-chat/admin/chats/${MasterChatState.selectedUserId}/close`, {
      method: "POST",
    });
    MasterChatState.selectedUserId = null;
    await masterChatLoadChats();
  }

  function masterChatInitWebSocket() {
    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const wsUrl = `${protocol}//${window.location.host}/support/master-chat/admin/ws`;
    MasterChatState.websocket = new WebSocket(wsUrl);

    MasterChatState.websocket.addEventListener("message", async (event) => {
      let payload;
      try {
        payload = JSON.parse(event.data);
      } catch (error) {
        return;
      }

      if (payload.event === "admin_connected") {
        return;
      }
      if (payload.event === "pong") {
        return;
      }

      await masterChatLoadChats();
      const payloadUserId =
        (payload.message && payload.message.user_id) ||
        (payload.chat && payload.chat.user_id) ||
        null;
      if (MasterChatState.selectedUserId && payloadUserId === MasterChatState.selectedUserId) {
        await masterChatSelectChat(MasterChatState.selectedUserId);
      }
    });

    MasterChatState.websocket.addEventListener("close", () => {
      window.setTimeout(masterChatInitWebSocket, 2000);
    });
  }

  async function masterChatInit() {
    masterChatSetChatControlsEnabled(false);

    document.getElementById("master-chat-prev-page").addEventListener("click", async () => {
      if (MasterChatState.page <= 1) {
        return;
      }
      MasterChatState.page -= 1;
      await masterChatLoadChats();
    });

    document.getElementById("master-chat-next-page").addEventListener("click", async () => {
      if (MasterChatState.page >= MasterChatState.totalPages) {
        return;
      }
      MasterChatState.page += 1;
      await masterChatLoadChats();
    });

    document.getElementById("master-chat-form").addEventListener("submit", masterChatSendMessage);
    document.getElementById("master-chat-close-btn").addEventListener("click", masterChatCloseSelectedChat);
    await masterChatLoadChats();
    masterChatInitWebSocket();
  }

  masterChatInit();
</script>
{% endblock %}
